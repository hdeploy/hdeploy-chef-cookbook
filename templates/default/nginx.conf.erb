# GENERATED BY CHEF
# Modify hdeploy-server.json to fine tune...

error_log stderr;

worker_processes <%= node['hdeploy-server']['nginx']['worker_processes'] %>;
daemon off;

events {
  worker_connections <%= node['hdeploy-server']['nginx']['worker_connections'] %>;
}

#FIXME: logrotate

http {
  #include      mime_types;
  default_type application/octet-stream;

  access_log /var/log/hdeploy/nginx/access.log;

  sendfile on;
  keepalive_timeout 10;
  tcp_nopush on;

<%
  require 'uri'
  if @sconf.has_key?('api') %>

  # Needed to load passenger
  passenger_root <%= `/opt/hdeploy-server/embedded/bin/passenger-config --root`.chomp %>;
  passenger_log_file /var/log/hdeploy/api.log;

  <% @sconf['api'].each do |api_name,api_conf| %>

  <%
    p = URI.parse(api_conf['url'])
     

  %>
  server {
    listen <%= (p.host == '127.0.0.1' or p.host == 'localhost') ? '127.0.0.1:' : '' %><%= p.port %><%= (p.scheme == 'https') ? ' ssl' : '' %>;
    server_name <%= p.host %>;

    location / {
      passenger_app_root /opt/hdeploy-server/embedded/api;
      passenger_enabled on;
      passenger_env_var HDEPLOY_API_NAME <%= api_name %>;

    }
  }

  <% end %>
<% end %>


<% if @sconf.has_key?('repository') %>
  <% @sconf['repository'].each do |repo_name,repo_conf| %>


  <% end %>
<% end %>

}